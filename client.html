<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="manifest" crossorigin="use-credentials" href="manifest.json">
    <title>Document</title>
</head>

<body>
    <div id="message"></div>
    <div class="row justify-content-around">
        <div class="col-12 col-md-6">
            <div class="card mx-auto mt-5" style="width: 80%;">
                <div class="card-body">
                    <form class="text-center" id="addSchedule">
                        <h1 class="mb-5">增加行程</h1>
                        <div class="col-auto my-1 form-group">
                            <div class="mr-sm-2 mb-3" for="date-selector">日期</div>
                            <select class="custom-select mr-sm-2" id="date-selector" name="date"></select>
                        </div>
                        <div class="col-auto my-4 form-group">
                            <div class="mb-3 mr-sm-2" for="time-selector">時間</div>
                            <select class="custom-select mr-sm-2" id="time-selector" name="time">
                                <option value="morning">早上</option>
                                <option value="afternoon">下午</option>
                            </select>
                        </div>
                        <div class="container">
                            <div class="input-group input-group-sm mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="item">行程項目</span>
                                </div>
                                <input name="schedule" id="inputItem" type="text" class="form-control" aria-label="Small" aria-describedby="item">
                            </div>
                        </div>
                        <hr width="80%" class="mx-auto my-4" />
                        <button type="submit" class="btn btn-primary">提交</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card mx-auto mt-5" style="width: 80%;">
                <div class="card-body">
                    <form class="text-center" id="removeSchedule">
                        <h1 class="mb-5">刪減行程</h1>
                        <div class="col-auto my-1 form-group">
                            <label class="mr-sm-2" for="remove-date-selector">日期 ｜</label>
                            <select class="custom-select mr-sm-2" id="remove-date-selector" name="date">
                                <option disabled>請選擇日期</option>
                            </select>
                        </div>
                        <div class="col-auto my-4 form-group">
                            <label class="mr-sm-2" for="remove-time-selector">時間 ｜</label>
                            <select class="custom-select mr-sm-2" id="remove-time-selector" name="time">
                                <option value="morning">早上</option>
                                <option value="afternoon">下午</option>
                            </select>
                        </div>
                        <div class="form-group row mx-auto" style="width: 65%;">
                            <label class="mr-sm-2" for="scheduleItem">行程項目</label>
                            <select class="custom-select mr-sm-2" id="scheduleItem" name="schedule"></select>
                        </div>
                        <hr width="80%" class="mx-auto my-4" />
                        <button type="submit" class="btn btn-primary">提交</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card mx-auto mt-5" style="width: 80%;">
                <div class="card-body">
                    <form class="text-center" id="add-leave-officer">
                        <h1 class="mb-5">增加請假人員</h1>
                        <div class="col-auto my-1 form-group">
                            <label class="mr-sm-2" for="leave-officer-date-selector">日期 ｜</label>
                            <select class="custom-select mr-sm-2" id="leave-officer-date-selector" name="date">
                                <option disabled>請選擇日期</option>
                            </select>
                        </div>
                        <div class="col-auto my-4 form-group">
                            <label class="mr-sm-2" for="leave-officer-time-selector">時間 ｜</label>
                            <select class="custom-select mr-sm-2" id="leave-officer-time-selector" name="time">
                                <option value="全天">全天</option>
                                <option value="上午">早上</option>
                                <option value="下午">下午</option>
                            </select>
                        </div>
                        <div class="container">
                            <div class="input-group input-group-sm mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="add-name">姓名</span>
                                </div>
                                <input name="name" id="add-leave-officer-name" type="text" class="form-control" aria-label="Small" aria-describedby="add-name">
                            </div>
                        </div>
                        <hr width="80%" class="mx-auto my-4" />
                        <button type="submit" class="btn btn-primary">提交</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card mx-auto mt-5" style="width: 80%;">
                <div class="card-body">
                    <form class="text-center" id="remove-leave-officer">
                        <h1 class="mb-5">刪減請假人員</h1>
                        <div class="col-auto my-1 form-group">
                            <label class="mr-sm-2" for="remove-leave-officer-date-selector">日期 ｜</label>
                            <select class="custom-select mr-sm-2" id="remove-leave-officer-date-selector" name="date">
                                <option disabled>請選擇日期</option>
                            </select>
                        </div>
                        <div class="mt-3 form-group row mx-auto" style="width: 50%;">
                            <label class="mr-sm-2 mb-3" for="leaveOfficers">請假人員</label>
                            <select class="custom-select mr-sm-2" id="leaveOfficers" name="name"></select>
                        </div>
                        <hr width="80%" class="mx-auto my-4" />
                        <button type="submit" class="btn btn-primary">提交</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="card mx-auto mt-5" style="width: 80%;">
        <div class="card-body">
            <form class="text-center" id="reminder">
                <div class="form-group">
                    <label for="reminder" class="my-3">記事</label>
                    <textarea class="form-control" id="reminder-text" name="note" rows="5"></textarea>
                </div>
                <button type="submit" class="mt-4 btn btn-primary">提交</button>
            </form>
        </div>
    </div>
    <div class="card mx-auto my-5">
        <div class="card-body">
            <form class="text-center" id="host">
                <div class="container mt-5">
                    <div class="input-group input-group-sm mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="ip-description">IP</span>
                        </div>
                        <input name="host" id="host-ip" type="text" class="form-control" aria-label="Small" aria-describedby="ip-description">
                    </div>
                </div>
                <span id="check-ip" type="submit" class="mt-4 btn btn-primary">確認</span>
            </form>
        </div>
    </div>
</body>

<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/getDates.js"></script>
<script>
    let message = document.getElementById("message")

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js')
                .then(function(registration) {})
                .catch(function(err) {})
        })
    }

    let host = document.getElementById("host-ip")

    document.getElementById("check-ip").addEventListener('click', (e) => {
        localStorage.setItem("host-ip", host.value)
        window.location.reload()
    })

    if (localStorage.getItem("host-ip") != "") {
        host.value = localStorage.getItem("host-ip")
    }


    function getItem(e) {
        e.preventDefault();

        let formData = new FormData(document.getElementById('removeSchedule')).entries()
        formData = Object.fromEntries(formData)

        fetch(host.value + '/api/getSchedules', {
                method: 'POST',
                body: new URLSearchParams({
                    'time': JSON.stringify(formData),
                }),
            })
            .then((res) => res.json())
            .then((data) => {
                document.getElementById('scheduleItem').innerHTML = ""

                data["item"].forEach((item) => {
                    let option = document.createElement("option")
                    option.innerText = item
                    option.setAttribute("value", item)
                    document.getElementById('scheduleItem').appendChild(option)
                })
            });
    }

    function getLeaveOfficers(e) {
        e.preventDefault();

        let formData = new FormData(document.getElementById('remove-leave-officer')).entries()
        formData = Object.fromEntries(formData)

        fetch(host.value + '/api/getLeaveOfficers', {
                method: 'POST',
                body: new URLSearchParams({
                    'leaveOfficer': JSON.stringify(formData),
                }),
            })
            .then((res) => res.json())
            .then((data) => {
                document.getElementById('leaveOfficers').innerHTML = ""

                data["names"].forEach((name) => {
                    console.log(name)
                    let option = document.createElement("option")
                    option.innerText = name
                    option.setAttribute("value", name)
                    document.getElementById('leaveOfficers').appendChild(option)
                })
            });
    }

    function pushDate(doc) {
        dates.forEach((date) => {
            let dateOption = document.createElement("option");
            dateOption.innerText = date;
            dateOption.setAttribute("value", date)
            doc.appendChild(dateOption);
        })
    }

    dates = getDates()

    pushDate(document.getElementById("date-selector"))
    pushDate(document.getElementById("remove-date-selector"))
    pushDate(document.getElementById("leave-officer-date-selector"))
    pushDate(document.getElementById("remove-leave-officer-date-selector"))

    let data;

    message.innerHTML = host.value

    fetch(host.value).then((res) => res.json()).then((d) => {
        message.innerHTML += "\n" + d
        console.log(d)
    })

    fetch(host.value + "/data.json")
        .then((response) => response.json())
        .then((_data) => {
            data = _data
            message.innerHTML += "\n" + "yes"
            document.getElementById("reminder-text").value = data["reminder"];
        })

    document.getElementById('addSchedule').addEventListener('submit', (e) => {
        e.preventDefault();

        let formData = new FormData(document.getElementById('addSchedule')).entries()
        formData = Object.fromEntries(formData)

        if (formData["schedule"]) {
            fetch(host.value + '/api/addSchedule', {
                method: 'POST',
                body: new URLSearchParams({
                    'schedule': JSON.stringify(formData),
                }),
            }).then((res) => {
                if (res.ok) {
                    document.getElementById("inputItem").value = ""
                }
            });
        }
    });

    document.getElementById('removeSchedule').addEventListener('submit', (e) => {
        e.preventDefault();

        let formData = new FormData(document.getElementById('removeSchedule')).entries()
        formData = Object.fromEntries(formData)

        if (formData["schedule"]) {
            fetch(host.value + '/api/removeSchedule', {
                method: 'POST',
                body: new URLSearchParams({
                    'schedule': JSON.stringify(formData),
                }),
            }).then((res) => {
                if (res.ok) {
                    window.location.reload()
                }
            });
        }
    });

    document.getElementById('add-leave-officer').addEventListener('submit', (e) => {
        e.preventDefault();

        let formData = new FormData(document.getElementById('add-leave-officer')).entries()
        formData = Object.fromEntries(formData)

        if (formData["name"]) {
            fetch(host.value + '/api/addLeaveOfficer', {
                method: 'POST',
                body: new URLSearchParams({
                    'leaveOfficer': JSON.stringify(formData),
                }),
            }).then((res) => {
                if (res.ok) {
                    document.getElementById("add-leave-officer-name").value = ""
                }
            });
        }
    });

    document.getElementById('remove-leave-officer').addEventListener('submit', (e) => {
        e.preventDefault();

        let formData = new FormData(document.getElementById('remove-leave-officer')).entries()
        formData = Object.fromEntries(formData)

        if (formData["name"]) {
            fetch(host.value + '/api/removeLeaveOfficer', {
                method: 'POST',
                body: new URLSearchParams({
                    'leaveOfficer': JSON.stringify(formData),
                }),
            }).then((res) => {
                if (res.ok) {
                    window.location.reload()
                }
            });
        }
    });

    document.getElementById('reminder').addEventListener('submit', (e) => {
        e.preventDefault();

        let formData = new FormData(document.getElementById('reminder')).entries()
        formData = Object.fromEntries(formData)

        fetch(host.value + '/api/changeReminder', {
            method: 'POST',
            body: new URLSearchParams({
                'reminder': JSON.stringify(formData),
            }),
        }).then((res) => {
            if (res.ok) {
                document.getElementById("reminder-text").value = ""
                window.location.reload()
            }
        });
    });

    document.getElementById('scheduleItem').addEventListener('click', getItem)
    document.getElementById('scheduleItem').addEventListener('change', (e) => {
        document.getElementById('scheduleItem').removeEventListener("click", getItem)
    })

    document.getElementById("remove-date-selector").addEventListener('change', (e) => {
        document.getElementById('scheduleItem').addEventListener('click', getItem)
    })

    document.getElementById("remove-time-selector").addEventListener('change', (e) => {
        document.getElementById('scheduleItem').addEventListener('click', getItem)
    })

    // leaveOfficers
    document.getElementById('leaveOfficers').addEventListener('click', getLeaveOfficers)
    document.getElementById('leaveOfficers').addEventListener('change', (e) => {
        document.getElementById('leaveOfficers').removeEventListener("click", getLeaveOfficers)
    })

    document.getElementById("remove-leave-officer-date-selector").addEventListener('change', (e) => {
        document.getElementById('leaveOfficers').addEventListener('click', getLeaveOfficers)
    })
</script>

</html>